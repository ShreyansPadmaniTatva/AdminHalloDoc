@using AdminHalloDoc.Entities.ViewModel;
@using AdminHalloDoc.Models.CV;
@using static AdminHalloDoc.Entities.ViewModel.Constant;
@{
    ViewData["Title"] = "Invoicing";
    var status = "null";
    if (TempData["Status"] == null)
    {
        status = "null";
    }
    else
    {
        status = TempData["Status"].ToString();

    }
}

<div class="container">
    <div class="justify-content-between d-flex container-fluid  position-relative ">
        <div class="">
            <h3 class="fw-bolder">
                Timesheets

            </h3>
        </div>
    </div>
    <div class="card border-0 shadow py-4 mb-5 mx-3 mt-3 rounded">
        <div class="text-end mx-2 px-3 d-flex justify-content-between">
            <div class="d-flex" >
                    <select class="form-select w-100 mx-3" id="physicianDropdown" data-allow-clear="true" tabindex="-1" asp-items="@(new SelectList(ViewBag.ProviderComboBox, "Physicianid", "Firstname"))" data-control="select" data-placeholder="Region">
                        <option id="defaultregion" value="">Select Physician</option>
                    </select>
                <div class="dropdown ">
                    <select class="form-select form-select-md" id="timesheets" data-placeholder="Select Period" style="width: 400px;">
                        <option></option>
                    </select>
                </div>
            </div>

            <div class="d-flex">

                <!-- Button trigger modal -->
                <a style="display:none" id="finalizeLink" class="btn btn-outline-info Finalize"> Finalize Timesheet  </a>
            </div>

        </div>
        <div class="my-3 mx-3" >
            <div id="notfinalize">
            </div>
        </div>
       
        <div id="pendinglist" class="table-responsive  d-md-block">
        </div>
        <div id="table" class="table-responsive  " style="display:none">
            <table class="table table-responsive mt-3 p-3">
                <thead>
                    <tr>
                        <th scope="col" style="width: 10%;">Date</th>
                        <th scope="col" style="width: 9%;">On-Call Hours</th>
                        <th scope="col" style="width: 17%;">Total Hours</th>
                        <th scope="col" style="width: 10%;" class="text-center">Weekend / Holiday</th>
                        <th scope="col" style="width: 16%;">Number of Housecalls</th>
                        <th scope="col" style="width: 17%;">Number of Phone Consults</th>
                    </tr>
                </thead>
                <tbody class="table-group-divider mx-5">
                </tbody>
            </table>
        </div>

    </div>
    <div class="card border-0 shadow py-4 mb-5 mx-3 mt-3 rounded">
        <div class="text-end mx-2 px-3 d-flex justify-content-between">
            <div class="dropdown ">

                <h4 class="fw-bolder"> Timesheets Reimbursement</h4>
            </div>

        </div>
        <div id="tableReimbursement" class="table-responsive  d-md-block">
        </div>

    </div>
</div>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


@section Scripts
    {
    <script>
        var loginId ;
        var selectedValue;


        function generateOptions() {
            var options = [];

            // Get the current date
            var currentDate = new Date();
            var currentYear = currentDate.getFullYear();
            var currentMonth = currentDate.getMonth() + 1; // Months are zero-based, so add 1

            // Loop through the previous 6 months
            for (var i = -6; i <= 6; i++) {
                var date = new Date(currentYear, currentMonth + i, 1); // Set the date to the 1st of the month

                var year = date.getFullYear();
                var month = date.getMonth(); // Months are zero-based, so add 1
                var daysInMonth = new Date(year, month, 0).getDate();

                // Add options for the first and second halves of the month
                var firstHalfText = year + "/" + month + "/" + date.getDate() + " - " + year + "/" + month + "/ 14";
                var secondHalfText = year + "/" + month + "/15 - " + year + "/" + month + "/ " + daysInMonth;

                options.push({ id: year + "-" + month + "-1", text: firstHalfText });
                options.push({ id: year + "-" + month + "-15", text: secondHalfText });

                // Set the default selection to the current month
                if (i === 0) {
                    var defaultSelection = (currentDate.getDate() <= 14) ? year + "-" + month + "-1" : year + "-" + month + "-15";
                }
            }

            return { options, defaultSelection };
        }

        $(document).ready(function () {

            function changedata(loginId, selectedValue) {
                myFunction(loginId, selectedValue);
                myFunctionfortimesheetData(loginId, selectedValue);
                $("#Startdate").val(selectedValue);
                $("#PhysicianId").val(loginId);

                var dateObj = new Date(selectedValue);

                var date = dateObj.getDate();
                var month = dateObj.getMonth() + 1; // Months are zero-based
                if (date == 1) {
                    $("#AfterDays").val(14);
                    var url = '@Url.Action("TimeSheetAddEdit", "Invoice")' + '?PhysicianId=' + loginId + '&StartDate=' + selectedValue;
                } else {
                    var daysInMonth = new Date(2024, month, 0).getDate();
                    $("#AfterDays").val(daysInMonth - 14);
                    var url = '@Url.Action("TimeSheetAddEdit", "Invoice")' + '?PhysicianId=' + loginId + '&StartDate=' + selectedValue;
                }

                $('#finalizeLink').attr('href', url).show();

                console.log($("#AfterDays").val());
            }

           
                    $('#physicianDropdown').change(function () {
                        // Update loginId with the selected value
                        loginId = $(this).val();
                checkisfinalize(loginId, selectedValue);
                    });
               
            $("#timesheets").change(function () {
                // Get the selected value
                 selectedValue = $(this).val();
                checkisfinalize(loginId, selectedValue);
            });
            function checkisfinalize(loginId, selectedValue) {
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("IsFinalizeSheet","Invoice")',
                    data: { PhysicianId: loginId, StartDate: selectedValue },
                    cache: false,
                    success: function (response) {

                        console.log(response);
                        if (response.x == true) {
                            $("#notfinalize").hide();
                            $('#pendinglist').empty();

                            var date = new Date(selectedValue); // Set the date to the 1st of the month

                            var year = date.getFullYear();
                            var month = date.getMonth()+1; // Months are zero-based, so add 1
                            var daysInMonth = new Date(year, month, 0).getDate();

                            // Create table elements
                            var table = $('<table class="table table-responsive mt-3 p-3"></table>');
                            var thead = $('<thead><tr><th scope="col">Start Date</th><th scope="col">End Date</th><th scope="col"  >Status</th><th scope="col" > Action</th></tr></thead>');
                            var tbody = $('<tbody class="table-group-divider mx-5"></tbody>');

                            // Append thead to table
                            table.append(thead);

                           
                                var row = '<tr>' +
                                '<td>' + selectedValue + '</td>' +
                                '<td>' + year + '-' + month + '-' + daysInMonth + '</td>' +
                                    '<td>Pending</td>' +

                                '<td><a  class="view-btn btn btn-outline-info" href="/Invoice/TimeSheetAddEdit?PhysicianId=' + loginId + '&StartDate=' + selectedValue + '">Approve</a></td>' +

                                '</tr>';
                                tbody.append(row);
                           

                            // Append tbody to table
                            table.append(tbody);

                            // Append table to the div
                            $('#pendinglist').append(table);
                        }
                        else {

                            $("#notfinalize").show();
                            var providerName = $(this).find('option:selected').text();
                            // Update the message
                            $("#notfinalize").html(providerName + " has not finalized the timesheet in specified time period.");
                        }
                    },
                    error: function () {
                        alert("Error while checking date.");
                    }
                });
            }
            // Get options and default selection
            var { options, defaultSelection } = generateOptions();
            $("#timesheets").select2({
                placeholder: "Select Period",
                data: options
            });
            $("#timesheets").val(defaultSelection).trigger("change");
        });

        window.onload = function () {
            console.log("@status  d");
            if ("@status" != "null") {
                savealt("@status")
            }

        };
        function myFunctionfortimesheetData(loginId, selectedValue) {

            $.ajax({
                type: "POST",
                url: '@Url.Action("GetTimesheetDetailsData","Invoice")',
                data: { PhysicianId: loginId, StartDate: selectedValue },
                cache: false,
                success: function (response) {
                    $('#table').empty();
                    $('#tableReimbursement').empty();
                    if (response == null) {
                        var table = $('<h2 class=" mt-3 p-3">No Record At</h2>');
                        $('#table').append(table);
                        $('#tableReimbursement').append(table);
                        return;
                    }
                    console.log(response);
                    // Clear existing table
                    $('#table').empty();

                    // Create table elements
                    var table = $('<table class="table table-responsive mt-3 p-3"></table>');
                    var thead = $('<thead><tr><th scope="col">Date</th><th scope="col">Shift</th><th scope="col"  class="text-center">NightShift Weekend</th><th scope="col" > Housecall</th><th scope="col" style="width: 13%;"> Housecall Nights Weekend</th><th scope="col" >Phone Consults</th><th scope="col" style="width: 14%;">Phone Consults Nights Weekend</th><th scope="col" >Batch Testing</th></tr></thead>');
                    var tbody = $('<tbody class="table-group-divider mx-5"></tbody>');

                    // Append thead to table
                    table.append(thead);

                    response.timesheetdetails.forEach(function (item) {
                        var totalHours = item.totalhours || 0;
                        var numberofhousecall = item.numberofhousecall || 0;
                        var numberofphonecall = item.numberofphonecall || 0;
                        var date = new Date(item.timesheetdate);
                        var formattedDate = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

                        var row = '<tr>' +
                            '<td>' + formattedDate + '</td>' +
                            '<td>' + totalHours + '</td>' +
                            '<td class="text-center">' + (item.isweekend ? '1' : '0') + '</td>' +
                            '<td>' + numberofhousecall + '</td>' +
                            '<td>0</td>' +
                            '<td>' + numberofphonecall + '</td>' +
                            '<td>0</td>' +
                            '<td>0</td>' +
                            '</tr>';
                        tbody.append(row);
                    });

                    // Append tbody to table
                    table.append(tbody);

                    // Append table to the div
                    $('#table').append(table);



                    $('#tableReimbursement').empty();

                    // Create table elements
                    var tabler = $('<table class="table table-responsive mt-3 p-3"></table>');
                    var theadr = $('<thead><tr><th scope="col">Date</th><th scope="col">Item</th><th scope="col"  >Amount</th><th scope="col" > Bill</th><th scope="col" style="width: 13%;">Action</th></tr></thead>');
                    var tbodyr = $('<tbody class="table-group-divider mx-5"></tbody>');

                    // Append thead to table
                    tabler.append(theadr);

                    response.timesheetdetailreimbursements.forEach(function (item) {
                        var totalHours = item.itemname || '-';
                        var amount = item.amount || 0;
                        var bill = item.bill || 0;
                        var date = new Date(item.timesheetdate);
                        var formattedDate = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

                        var row = '<tr>' +
                            '<td>' + formattedDate + '</td>' +
                            '<td>' + totalHours + '</td>' +
                            '<td>' + amount + '</td>' +
                            '<td>' + bill + '</td>' +
                            '<td><a target="_blank" class="view-btn btn btn-outline-info" href="/Upload/TimeSheet/' + item.timesheetid + '/' + bill + '">View</a></td>' +
                            '</tr>';
                        tbodyr.append(row);
                    });

                    // Append tbody to table
                    tabler.append(tbodyr);

                    // Append table to the div
                    $('#tableReimbursement').append(tabler);
                },
                error: function () {
                    alert("Error while checking data.");
                }
            });
        }

        $('.view-btn').click(function () {
            var url = $(this).data('url');
            window.open(url, '_blank');
        });
        function myFunction(loginId, selectedValue) {

            $.ajax({
                type: "POST",
                url: '@Url.Action("IsFinalizeSheet","Invoice")',
                data: { PhysicianId: loginId, StartDate: selectedValue },
                cache: false,
                success: function (response) {

                    console.log(response);
                    if (response.x == true) {
                        $(".Finalize").hide();
                    }
                    else {
                        $(".Finalize").show();
                    }
                },
                error: function () {
                    alert("Error while checking date.");
                }
            });
        }
    </script>
}
