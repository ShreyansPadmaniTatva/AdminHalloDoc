@using AdminHalloDoc.Entities.ViewModel;
@using AdminHalloDoc.Models.CV;
@using static AdminHalloDoc.Entities.ViewModel.Constant;
@model AdminHalloDoc.Entities.ViewModel.AdminViewModel.ViewTimeSheet
@{
    ViewData["Title"] = "Invoicing";
    var status = "null";
    if (TempData["Status"] == null)
    {
        status = "null";
    }
    else
    {
        status = TempData["Status"].ToString();

    }
}

<div class="container" >
    <div class="justify-content-between d-flex container-fluid  position-relative ">
        <div class="">
           
        </div>
        <div class="">
            <a href="javascript:void(0)" onclick="goBack()" class="btn btn-outline-info"> ❮  Back </a>
        </div>
    </div>
    <div class="card border-0 shadow py-4 mb-5 mx-3 mt-3 rounded">
       

        <div id="table" class="table-responsive  d-md-block">
            @using (Html.BeginForm("TimeSheetDetailsEdit", "Invoice", FormMethod.Post))
            {
                <input type="hidden" name="PhysicianId" value="@Model.PhysicianId" />
                <table class="table table-responsive mt-3 p-3">
                    <thead>
                        <tr>
                            <th scope="col" style="width: 10%;">Date</th>
                            <th scope="col" style="width: 9%;">On-Call Hours</th>
                            <th scope="col" style="width: 17%;">Total Hours</th>
                            <th scope="col" style="width: 10%;" class="text-center">Weekend / Holiday</th>
                            <th scope="col" style="width: 16%;">Number of Housecalls</th>
                            <th scope="col" style="width: 17%;">Number of Phone Consults</th>
                        </tr>
                    </thead>
                    <tbody class="table-group-divider mx-5">
                        @for (int i = 0; i < Model.Timesheetdetails.Count; i++)
                        {
                            <tr>
                                <td scope="col">
                                    @Html.HiddenFor(m => m.Timesheetdetails[i].Timesheetdetailid)
                                    @Html.HiddenFor(m => m.Timesheetdetails[i].Timesheetdate)
                                    @Html.DisplayFor(m => m.Timesheetdetails[i].Timesheetdate)
                                </td>
                                <td scope="col">
                                    @Html.DisplayFor(m => m.Timesheetdetails[i].OnCallhours)
                                </td>
                                <td scope="col">
                                    <div class="">
                                        @Html.TextBoxFor(m => m.Timesheetdetails[i].Totalhours, new { @class = "pay-in form-control form-control-disable rounded mail-billing-imp", autocomplete = "off" })
                                    </div>
                                </td>
                                <td scope="col" class="text-center">
                                    <div class="form-floating">
                                      @{
                                            bool isWeekend = (bool)Model.Timesheetdetails[i].Isweekend ;
                                    }
                                        @*@Html.CheckBoxFor(m => (bool)m.Timesheetdetails[i].Isweekend, new { @class = "form-check-input form-check-inputs" })*@
                                        @Html.CheckBoxFor(m => Model.Timesheetdetails[i].Isweekend, new { @class = "form-check-input form-check-inputs", id = $"Isweekend_{i}" })
                                        @*@Html.CheckBoxFor(m =>isWeekend, new { @class = "form-check-input form-check-inputs"})*@
                                        @*@Html.HiddenFor(m => m.Timesheetdetails[i].Isweekend)*@
                                        @*<input type="checkbox" asp-for="@Model.Timesheetdetails[i].Isweekend" value="@Model.Timesheetdetails[i].Isweekend" class="form-check-input form-check-inputs">*@
               
                                    </div>
                                </td>
                                <td scope="col">
                                    <div class="">
                                        @Html.TextBoxFor(m => m.Timesheetdetails[i].Numberofhousecall, new { @class = "pay-in form-control form-control-disable rounded mail-billing-imp", autocomplete = "off" })
                                    </div>
                                </td>
                                <td scope="col">
                                    <div class="">
                                        @Html.TextBoxFor(m => m.Timesheetdetails[i].Numberofphonecall, new { @class = "pay-in form-control form-control-disable rounded mail-billing-imp", autocomplete = "off" })
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                <div class="text-end" >
                      <button type="submit" class="btn btn-info text-white">Submit</button>
                </div>
            }
        </div>
        
    </div>
    <div class="card border-0 shadow py-4 mb-5 mx-3 mt-3 rounded">
        <div class="text-end mx-2 px-3 d-flex justify-content-between">
            <div class="dropdown ">

                <h4 class="fw-bolder"> Timesheets Reimbursement</h4>
            </div>
            <div class="d-flex">
                <form asp-action="ChangeNotificationPhysician" class="mx-2" id="saveChangesForm" asp-controller="Physician">
                    <input type="hidden" id="changedValuesInput" name="changedValues">
                    <button class="btn btn-outline-info " style="display:none;" type="submit" id="saveChangesButton"> Save Changes </button>
                </form>
                <!-- Button trigger modal -->
               
            </div>

        </div>
        <div id="table" class="table-responsive  d-md-block">
            
        </div>

    </div>
</div>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


@section Scripts
    {
<script>
        var loginId = @CV.UserID();
       
        function generateOptions() {
            var options = [];

            // Get the current date
            var currentDate = new Date();
            var currentYear = currentDate.getFullYear();
            var currentMonth = currentDate.getMonth() + 1; // Months are zero-based, so add 1

            // Loop through the previous 6 months
            for (var i = -6; i <= 6; i++) {
                var date = new Date(currentYear, currentMonth + i, 1); // Set the date to the 1st of the month

                var year = date.getFullYear();
                var month = date.getMonth() ; // Months are zero-based, so add 1
                var daysInMonth = new Date(year, month, 0).getDate();

                // Add options for the first and second halves of the month
                var firstHalfText = year + "/" + month + "/" + date.getDate() + " - "+ year + "/" + month + "/ 14" ;
                var secondHalfText = year + "/" + month + "/15 - "+ year + "/" + month + "/ " + daysInMonth ;

                options.push({ id: year + "-" + month + "-1", text: firstHalfText });
                options.push({ id: year + "-" + month + "-15", text: secondHalfText });

                // Set the default selection to the current month
                if (i === 0) {
                    var defaultSelection = (currentDate.getDate() <= 14) ? year + "-" + month + "-1" : year + "-" + month + "-15";
                }
            }

            return { options, defaultSelection };
        }
        $(document).ready(function () {
            $('.form-check-input').change(function () {
                var index = $(this).attr('id').split('_')[1];
                var isChecked = $(this).is(':checked');
                $('#Isweekend_' + index).val(isChecked);
            });

            $('#timesheetForm').submit(function (e) {
                e.preventDefault(); // Prevent the form from submitting normally

                var formData = $(this).serialize();
                console.log(formData);
                $.ajax({
                    url: '@Url.Action("TimeSheetDetailsEdit", "Invoice")',
                    type: 'POST',
                    data:  formData ,
                    success: function (response) {
                        // Handle success response
                    },
                    error: function (xhr, status, error) {
                        // Handle error
                    }
                });
            });
        });

        $(document).ready(function () {
            $("#timesheets").change(function () {
                // Get the selected value
                var selectedValue = $(this).val();
                myFunction(loginId, selectedValue);
                $("#Startdate").val(selectedValue);
                $("#PhysicianId").val(loginId);
                // Parse the selected date
                var dateObj = new Date(selectedValue);

                var date = dateObj.getDate();
                var month = dateObj.getMonth() + 1; // Months are zero-based
                if(date == 1){
                    $("#AfterDays").val(14);
                }else{
                    var daysInMonth = new Date(2024, month, 0).getDate();
                    $("#AfterDays").val(daysInMonth - 14);
                }
                console.log($("#AfterDays").val());
            });
            // Get options and default selection
            var { options, defaultSelection } = generateOptions();

                //$('.js-example-basic-single').select2();
            // Initialize Select2
            $("#timesheets").select2({
                placeholder: "Select Period",
                
                data: options
              
            });

            // Set default selection
            $("#timesheets").val(defaultSelection).trigger("change");
        });


        window.onload = function () {
            console.log("@status  d");
            if ("@status" != "null") {
                savealt("@status")
            }

        };

       function myFunction(loginId, selectedValue) {
        
        $.ajax({
            type: "POST",
            url: '@Url.Action("IsFinalizeSheet","Invoice")',
                data: { PhysicianId: loginId, StartDate: selectedValue },
            cache: false,
            success: function (response) {

                console.log(response);
                if(response.x == true){
                            $(".Finalize").hide();
                }
                else{
                            $(".Finalize").show();
                }
            },
            error: function () {
                alert("Error while checking email.");
            }
        });
    }
</script>
}
